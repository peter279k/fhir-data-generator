<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="This is the web demonstration for MITW Connectathon" />
        <meta name="author" content="" />
        <title>MITW 2024 Track</title>
        <link href="../css/styles.css" rel="stylesheet" />
        <script src="../js/all.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="../css/sweetalert2.min.css">

        <link rel="apple-touch-icon" href="../assets/img/favicons/apple-touch-icon.png" sizes="180x180">
        <link rel="icon" href="../assets/img/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
        <link rel="icon" href="../assets/img/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
        <link rel="mask-icon" href="../assets/img/favicons/safari-pinned-tab.svg" color="#7952b3">
        <link rel="icon" href="../assets/img/favicons/favicon.ico">
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="index.html">fhir-data-generator</a>
            <!-- Sidebar Toggle-->
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">系統設定</div>
                            <a class="nav-link" href="index.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                基本設定
                            </a>
                            <div class="sb-sidenav-menu-heading">Resources</div>
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts" aria-expanded="false" aria-controls="collapseLayouts">
                                <div class="sb-nav-link-icon"><i class="fas fa-file"></i></div>
                                Track#1
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="collapseLayouts" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion"></div>
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts2" aria-expanded="false" aria-controls="collapseLayouts">
                                <div class="sb-nav-link-icon"><i class="fas fa-file"></i></div>
                                Track#2
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="collapseLayouts2" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="track2/patient.html">Patient</a>
                                </nav>
                            </div>
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts3" aria-expanded="false" aria-controls="collapseLayouts">
                                <div class="sb-nav-link-icon"><i class="fas fa-file"></i></div>
                                Track#13
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="collapseLayouts3" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="layout-static.html">Static Navigation</a>
                                    <a class="nav-link" href="layout-sidenav-light.html">Light Sidenav</a>
                                </nav>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
            <div id="layoutSidenav_content">
                <main>
                    <div class="container-fluid px-4">
                        <h1 class="mt-4">Resource log</h1>
                        <ol class="breadcrumb mb-4">
                            <li class="breadcrumb-item active">瀏覽上傳到FHIR server的Resources</li>
                        </ol>
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a id="track-server-tab" class="nav-link active" aria-current="page" href="#">瀏覽resources</a>
                            </li>
                        </ul>
                        <div class="card mb-4">
                            <div class="card-body">
                                <form role="form">
                                    <div class="mb-3">
                                        <label for="connect-activity" class="form-label">請選擇年度聯測松</label>
                                        <select class="form-select" id="connect-activity" aria-label=""></select>
                                    </div>

                                    <button id="query-list-btn" type="button" class="btn btn-primary">送出</button>
                                    <button type="reset" class="btn btn-secondary">重設</button>
                                </form>
                            </div>
                        </div>
                        <div id="search-result-card" class="card mb-4 d-none">
                            <div id="result-card-header" class="card-header">查詢結果</div>
                            <div id="search-result-table" class="card-body"></div>
                        </div>
                    </div>
                </main>
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; fhir-data-generator 2024</div>
                            <div>
                                <a target="_blank" href="https://github.com/peter279k/fhir-data-generator">GitHub連結</a>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="../js/scripts.js"></script>
        <script src="../js/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="../js/sweetalert2.all.min.js"></script>
        <script src="../js/loadIGNavLink.js"></script>
        <script src="../js/FileSaver.min.js"></script>
        <script>
            $(async () => {
                loadIGNavLink();

                await $.ajax({
                    url: '/resources/connect_name_lists',
                    method: 'GET',
                }).done((data) => {
                    let connectLists = '';
                    for (let index=0; index<data.data.length; index++) {
                        connectLists += `<option value="${data.data[index]}">${data.data[index]}</option>`;
                    }
                    $('#connect-activity').html(connectLists);
                }).fail((error) => {
                    console.log(error);
                });

                $(document).on('click', 'a[name="download-resource-file"]', (e) => {
                    e.preventDefault();
                    let fileUrl = e.currentTarget.getAttribute('url');
                    let fileName = e.currentTarget.getAttribute('file_name');
                    window.saveAs(fileUrl, `${fileName}`);
                });

                $('#query-list-btn').click(async (e) => {
                    e.preventDefault();
                    let connectName = $('#connect-activity :selected').val();
                    await $.ajax({
                        url: `/resources/${connectName}`,
                        method: 'GET',
                    }).done((data) => {
                        let tableContents = '<table class="table table-striped">';
                        tableContents += `
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">賽道編號</th>
                                <th scope="col">resource名稱</th>
                                <th scope="col">resource id</th>
                                <th scope="col">FHIR server endpoint</th>
                                <th scope="col">連結</th>
                                <th scope="col">下載</th>
                            </tr>
                        </thead><tbody>`;
                        for (let index=0; index<data.data.length; index++) {
                            if (data.data[index]['resource_name'].includes('Observation')) {
                                data.data[index]['resource_name'] = data.data[index]['resource_name'].substring(0, 11);
                            }

                            tableContents += `
                                <tr>
                                    <th scope="row">${index+1}</th>
                                    <td>${data.data[index]['track_number']}</td>
                                    <td>${data.data[index]['resource_name']}</td>
                                    <td>${data.data[index]['resource_id']}</td>
                                    <td>${data.data[index]['fhir_server_endpoint']}</td>
                                    <td>
                                        <a class="text-primary" target="_blank" href="${data.data[index]['fhir_server_endpoint']}/${data.data[index]['resource_name']}/${data.data[index]['resource_id']}">link</a>
                                    </td>
                                    <td>
                                        <a name="download-resource-file" href="javascript:" class="text-primary" file_name="track${data.data[index]['track_number']}_${data.data[index]['resource_name']}_${data.data[index]['resource_id']}.json" url="${data.data[index]['fhir_server_endpoint']}/${data.data[index]['resource_name']}/${data.data[index]['resource_id']}">下載</a>
                                    </td>
                                </tr>
                            `;
                        }
                        tableContents += '</tbody></table>';

                        $('#search-result-card').removeClass('d-none');
                        $('#search-result-table').html(tableContents);
                    }).fail((error) => {
                        console.log(error);
                    });
                });
            });
        </script>
    </body>
</html>
